var boundmap,box=document.getElementById("demonstration").getBoundingClientRect(),width=box.width,height=box.height,svg=d3.select("#svg").attr({viewBox:[-10,-10,width+20,height+20].join(" ")}).on("mousemove",function(){var e=[d3.event.clientX-box.left,d3.event.clientY-box.top];return{x:e[0],y:e[1],weight:30,value:30}}).on("click",function(){var e;if(boundmap)return e=[d3.event.clientX-box.left,d3.event.clientY-box.top],boundmap.sites.push({x:e[0],y:e[1],weight:30,value:30})}),colors=d3.scale.ordinal().range(["#f381cf","#c775e1","#907bdb","#81b1da","#a9e0ea","#8ebc1a","#e3a735","#d47b11","#c34128"]),render=function(){var o=d3.scale.linear().domain([0,width]).range([0,width]),i=d3.scale.linear().domain([0,height]).range([0,height]),n=treemap.getPolygons(),r=treemap.getSites(),e=svg.selectAll("path.voronoi").data(n);return e.enter().append("path").attr({class:"voronoi"}),e.exit().remove(),svg.selectAll("path.voronoi").attr({d:function(r){var a;return r&&r.length?["M"+o(r[0].x)+" "+i(r[0].y)].concat(function(){for(var e=[],t=1,n=r.length;t<n;++t)a=t,e.push("L"+o(r[a].x)+" "+i(r[a].y));return e}(),["L"+o(r[0].x)+" "+i(r[0].y)].join(" ")):""},fill:function(e,t){return r[t]&&0===r[t].lv?"rgba("+(t=d3.rgb(colors(t))).r+","+t.g+","+t.b+",1.0)":"rgba(0,0,0,0.0)"},stroke:function(e,t){return"#000"},"stroke-width":function(e,t){return r[t]&&0===r[t].lv?5:1}}).on("mouseover",function(){return d3.select(this).attr({fill:"rgba(0,0,0,0.5)"})}).on("mouseout",function(){return d3.select(this).attr({fill:"rgba(0,0,0,0.1)"})}).on("click",function(e,t){return r[t].value+=1e3,setTimeout(function(){return treemap.updateValue(),render()},0)}),(e=svg.selectAll("circle.site").data(r.filter(function(e,t){return n[t].length&&!e.boundary&&!e.children}))).enter().append("circle").attr({class:"site"}),e.exit().remove(),svg.selectAll("circle.site").attr({cx:function(e){return o(e.x)},cy:function(e){return i(e.y)},r:function(e){return Math.sqrt(e.value)},fill:"#fff",stroke:"#000",opacity:function(){return.1}}).on("click",function(e,t){if(e.value+=1e3,setTimeout(function(){return treemap.updateValue(),render()},0),boundmap)return(t=boundmap.sites[t]).value=Math.pow(Math.sqrt(t.value)+10,2),t.weight=t.value,boundmap.resetWeight(),d3.event.preventDefault(),d3.event.stopPropagation(),d3.returnValue=!1,d3.cancelBubble=!0})},makedata=function(e){var t,n,r,a,o;if(null==e&&(e=0),t=parseInt(8*Math.random())+2,0===e&&(t=8),1===e&&(t=3),2===e&&(t=3),3<=e)return{value:100*parseInt(2*Math.random())+30,name:Math.random()};for(r=[],a=0;a<t;++a)r.push(makedata(e+1));return o=(n=r).reduce(function(e,t){return e+t.value},0),{children:n,value:o}},data=makedata(),c1={children:[{value:2001},{value:2002},{value:2003}],value:6006},c2={children:[{value:31},{value:32},{value:2003}],value:2066},testdata={children:[c1,c2],value:8072},treemap=new voronoi.Treemap(data,voronoi.Polygon.create(width,height,100),width,height);setInterval(function(){return treemap.compute(),render()},50);